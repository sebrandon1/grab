name: Nightly Grab Test

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  pull_request:
    branches:
      - main
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  nightly-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
      
    - name: Build grab binary
      run: make build
      
    - name: Verify binary exists
      run: |
        if [ ! -f "./grab" ]; then
          echo "Binary not found!"
          exit 1
        fi
        ./grab --help
        
    - name: Test download - Single file with verbose output (with fallbacks)
      run: |
        echo "Testing single file download with verbose output..."
        
        # Define URLs to try for ~10KB file - using reliable GitHub raw URLs
        urls=(
          "https://httpbin.org/bytes/10240"
          "https://raw.githubusercontent.com/golang/go/master/LICENSE"
          "https://raw.githubusercontent.com/kubernetes/kubernetes/master/README.md"
          "https://raw.githubusercontent.com/microsoft/vscode/main/package.json"
        )
        
        downloaded_file=""
        success=false
        
        for url in "${urls[@]}"; do
          echo "Trying URL: $url"
          if ./grab download "$url" -v; then
            # Determine the expected filename based on the URL
            if [[ "$url" == *"/bytes/10240" ]]; then
              downloaded_file="10240"
            elif [[ "$url" == *"/LICENSE" ]]; then
              downloaded_file="LICENSE"
            elif [[ "$url" == *"/README.md" ]]; then
              downloaded_file="README.md"
            elif [[ "$url" == *"/package.json" ]]; then
              downloaded_file="package.json"
            fi
            
            if [ -f "$downloaded_file" ]; then
              echo "‚úÖ Successfully downloaded from: $url"
              success=true
              break
            fi
          fi
          echo "‚ùå Failed to download from: $url"
          sleep 2  # Brief delay between attempts
        done
        
        if [ "$success" != "true" ]; then
          echo "‚ùå All download URLs failed!"
          exit 1
        fi
        
        echo "DOWNLOADED_FILE=$downloaded_file" >> $GITHUB_ENV
        
    - name: Verify download
      run: |
        downloaded_file="${DOWNLOADED_FILE}"
        
        if [ ! -f "$downloaded_file" ]; then
          echo "Downloaded file '$downloaded_file' not found!"
          exit 1
        fi
        
        # Check file size - be flexible for different sources
        actual_size=$(wc -c < "$downloaded_file")
        
        # Verify file size based on source type
        if [[ "$downloaded_file" == "10240" ]]; then
          # httpbin should give exactly 10240 bytes
          expected_size=10240
          if [ "$actual_size" -ne "$expected_size" ]; then
            echo "File size mismatch! Expected: $expected_size, Got: $actual_size"
            exit 1
          fi
        else
          # For GitHub files, just verify it's a reasonable size (> 500 bytes, < 1MB)
          if [ "$actual_size" -lt 500 ]; then
            echo "File too small! Got: $actual_size bytes (expected > 500)"
            exit 1
          elif [ "$actual_size" -gt 1048576 ]; then
            echo "File too large! Got: $actual_size bytes (expected < 1MB)"
            exit 1
          fi
        fi
        
        echo "‚úÖ Single file download test passed! (File: $downloaded_file, Size: $actual_size bytes)"
        
    - name: Test download - Multiple files (with fallbacks)
      run: |
        echo "Testing multiple file downloads..."
        
        # Try multiple URL combinations for robustness
        url_sets=(
          "https://httpbin.org/bytes/5120 https://httpbin.org/json"
          "https://raw.githubusercontent.com/golang/go/master/go.mod https://raw.githubusercontent.com/golang/go/master/go.sum"
          "https://raw.githubusercontent.com/kubernetes/kubernetes/master/go.mod https://raw.githubusercontent.com/microsoft/vscode/main/package.json"
        )
        
        success=false
        downloaded_files=()
        
        for url_set in "${url_sets[@]}"; do
          echo "Trying URL set: $url_set"
          
          # Clean up any previous downloads
          rm -f 5120 json go.mod go.sum package.json
          
          if ./grab download $url_set; then
            # Check what files were downloaded
            for potential_file in 5120 json go.mod go.sum package.json; do
              if [ -f "$potential_file" ]; then
                downloaded_files+=("$potential_file")
              fi
            done
            
            if [ ${#downloaded_files[@]} -ge 2 ]; then
              echo "‚úÖ Successfully downloaded ${#downloaded_files[@]} files: ${downloaded_files[*]}"
              success=true
              break
            fi
          fi
          
          echo "‚ùå Failed to download sufficient files from: $url_set"
          sleep 2
        done
        
        if [ "$success" != "true" ]; then
          echo "‚ùå All multiple download URL sets failed!"
          exit 1
        fi
        
        # Store the downloaded files for verification
        echo "DOWNLOADED_FILES=${downloaded_files[*]}" >> $GITHUB_ENV
        
    - name: Verify multiple downloads
      run: |
        downloaded_files_str="${DOWNLOADED_FILES}"
        IFS=' ' read -ra files <<< "$downloaded_files_str"
        
        echo "Verifying ${#files[@]} downloaded files: ${files[*]}"
        
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå File '$file' not found!"
            exit 1
          fi
          
          actual_size=$(wc -c < "$file")
          echo "üìÅ File: $file, Size: $actual_size bytes"
          
          # Verify file based on its type/name
          case "$file" in
            "5120")
              # httpbin bytes file should be exactly 5120
              if [ "$actual_size" -ne 5120 ]; then
                echo "‚ùå File size mismatch for $file! Expected: 5120, Got: $actual_size"
                exit 1
              fi
              ;;
            "json")
              # Verify it's valid JSON
              if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚ùå File '$file' is not valid JSON!"
                exit 1
              fi
              ;;
            "go.mod"|"go.sum"|"package.json")
              # Verify reasonable file size (> 50 bytes, < 100KB)
              if [ "$actual_size" -lt 50 ] || [ "$actual_size" -gt 102400 ]; then
                echo "‚ùå File '$file' has unreasonable size: $actual_size bytes"
                exit 1
              fi
              
              # For JSON files, verify valid JSON
              if [[ "$file" == *".json" ]]; then
                if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                  echo "‚ùå File '$file' is not valid JSON!"
                  exit 1
                fi
              fi
              ;;
            *)
              # Generic file - just check it's not empty and not too large
              if [ "$actual_size" -lt 1 ] || [ "$actual_size" -gt 1048576 ]; then
                echo "‚ùå File '$file' has unreasonable size: $actual_size bytes"
                exit 1
              fi
              ;;
          esac
          
          echo "‚úÖ File '$file' verified successfully"
        done
        
        echo "‚úÖ Multiple file download test passed! Verified ${#files[@]} files."
        
    - name: Test hash command
      run: |
        echo "Testing hash functionality..."
        
        # Get the files we downloaded
        single_file="${DOWNLOADED_FILE}"
        downloaded_files_str="${DOWNLOADED_FILES}"
        IFS=' ' read -ra multi_files <<< "$downloaded_files_str"
        
        # Test hashing on the single downloaded file
        if [ -n "$single_file" ] && [ -f "$single_file" ]; then
          echo "Testing hash on single file: $single_file"
          ./grab hash "$single_file" --type sha256
          ./grab hash "$single_file" --type sha1
          ./grab hash "$single_file" --type md5
        fi
        
        # Test hashing on one of the multiple files
        if [ ${#multi_files[@]} -gt 0 ]; then
          test_file="${multi_files[0]}"
          echo "Testing hash on multi-download file: $test_file"
          ./grab hash "$test_file" --type sha256
          ./grab hash "$test_file" --type md5
        fi
        
        echo "‚úÖ Hash command test passed!"
        
    - name: Test edge case - Invalid URL
      run: |
        echo "Testing error handling with invalid URL..."
        
        # This should fail gracefully
        if ./grab download "not-a-valid-url"; then
          echo "Expected download to fail for invalid URL, but it succeeded!"
          exit 1
        fi
        
        echo "‚úÖ Error handling test passed!"
        
    - name: Report success
      run: |
        echo "üéâ All nightly tests passed successfully!"
        echo "- Binary build: ‚úÖ"
        echo "- Single file download: ‚úÖ" 
        echo "- Multiple file downloads: ‚úÖ"
        echo "- Hash functionality: ‚úÖ"
        echo "- Error handling: ‚úÖ"
